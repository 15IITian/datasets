name: Unittests

on: push

jobs:
  pytest-job:
    name: "Core TFDS tests on ${{ matrix.os }} with ${{ matrix.tf_version }}"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        tf_version: ["tensorflow", "tf-nightly"]
        os: [ubuntu-latest, windows-latest]
      fail-fast: false

    steps:
    # Do not cancel actions on the main branch (as it mark the unittests as
    # failed)
    - if: ${{ github.ref != 'refs/heads/master' }}
      uses: styfle/cancel-workflow-action@0.9.1
      with:
        access_token: ${{ github.token }}

    - uses: actions/checkout@v2

    # Install deps
    - uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - run: pip --version
    - run: pip install ${{ matrix.tf_version }}

    # Install the protocol buffer compiler for gcld3 tests.
    # Install ffmpeg for Audio FeatureConnector tests.
    # Install tensorflow_io for lsun tests.
    - name: Install ubuntu dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt install -y protobuf-compiler
        sudo apt-get install ffmpeg
        pip install pytest pytest-cov
        pip install -e .[tests-all]
        pip install tensorflow_io

    - name: Install windows dependencies
      if: matrix.os == 'windows-latest'
      run: |
        choco install -y protoc
        choco install ffmpeg
        pip install -e .[test-all-windows]
        pip install tensorflow_io

    # Run tests
    - name: Run core tests
      run: |
        pytest -vv -n auto --ignore="tensorflow_datasets/audio/nsynth_test.py" --ignore="tensorflow_datasets/core/features/features_test.py" --ignore="tensorflow_datasets/testing/test_utils.py" --ignore="tensorflow_datasets/image/lsun_test.py" --ignore="tensorflow_datasets/rlds/robosuite_panda_pick_place_can/robosuite_panda_pick_place_can_test.py" --ignore="tensorflow_datasets/image_classification/imagenet2012_corrupted_test.py" --ignore="tensorflow_datasets/scripts/documentation/build_api_docs_test.py"
